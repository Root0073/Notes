# Application of Internet
http: 在http中客户端打开与服务器的连接，并向其发送命令,以文档为中心
最常见的命令是get

BitTorrent:将文件分割成片段
这些协作的客户端被称为群集

**他们机制都是可靠的双向字节流**

但在BitTorrent中，客户端想要下载文件需要先找到一个成为种子文件的东西
他包含了想要下载数据文件的一切信息，包括追踪器是谁（追踪谁是群集的成员）
客户端之间动态交换数据的密集连截图

Skype:基于NAT.可以向外打开连接到互联网，但是互联网的其他节点不容易向你打开链接

# The Four Layer Internet Model
1. 链路层： 互联网由终端主机，链路和路由器构成

链路层的工作是一次将数据通过一条链路进行运输

2. 网络层：将数据包从源端到目的端，跨越整个互联网，进行端到端的传输

数据包：给那些带有头部信息的数据集合起的名字，网络层的数据包被称为数据报
他们由一些数据和一个包含发送和接收地址的头部组成

网络将数据报交给链路层，指示他通过第一条链路发送数据报，即链路层为网络层提供服务

在链路的另一端是一个路由器，路由器的链路层从链路接收数据报，并将其交给路由器内部的网络层

路由器上的网络层将检查数据报的目的地址，并负责将数据报一步一步地向起最终目的地路由，他通过再次将其发送给链路层使其通过下一条链路传输

网络层不需要关心链路层如何通过每条链路发送数据报

**网络层是特殊的：当我们向互联网发送数据报时，必须使用互联网协议（IP）**

IP会尽最大努力尝试将数据报送达另一段，但是他不做保证

IP数据报可能会丢失，他们可能会无序送达甚至损坏

3. 传输层：如果让数据在必要时能够重新传，并且按顺序无误地送达另一端，那么就要在ip之上运行另一个协议

最常见的协议是TCP，他的任务是确保互联网在一端发送的应用程序数据能够准确按顺序的送达互联网另一端的应用程序

如果应用程序不需要可靠的送达，那么他可以使用更简单的UDP，他完全不提供送达保证

4. 应用层：应用程序可以通过应用层到TCP或UDP服务的明确定义的API来复用传输层
## Summary
应用层： 通过一些特定的协议来进行两个应用程序之间的双向字节流

运输层： 保证数据端到端的正确有序传递，并控制堵塞

网络层： 负责端到端的数据报传递

链路层： 负责在终端主机和路由器之间或两个路由器之间通过单一链路传递数据

# The IP Service Model
IP数据报由头部和一些数据组成，当传输层由数据要发送时，他会将传输段交给下方的网络层，网络层将传输段放入他创建的新IP数据报中，IP的任务是将数据报送达网络的另一端

IP将数据报发送给链路层，链路层将其放入一个链路镇，然后将其发送到第一个路由器

IP服务的四个特性：
1. 不可靠

2. 是一种数据包服务 (数据报是自包含的)
头部包含目标的IP地址，我们成为IPDA， 所有的转发决策都基于这个IPDA
数据报头部还包含一个IP愿地址IPSA， 表明数据报的来源

3. IP承诺只在必要时会丢弃数据报

4. 无连接的
开始时不建立任何通信相关的端到端状态

IP试图防止数据报永远循环，在其头部加了一个计数器来统计经过的路由器数，如果超过了128则丢弃

如果数据报太长，IP会将其分片

IP使用头部校验来减少将数据报传输到错误目的地的可能性

IP允许在数据报头部增加新字段

IPv4是32字节，IPv6是128字节
IP头部中最重要的字段是目标IP地址，源IP地址和协议id（告诉我们数据字段中包含的内容）

## Why is the IP service so simple?
为了保持网络的简单，傻瓜化和最小化
IP对链路层做了非常少的假设，对其几乎没有期望

# A Day in the Life of a Packet
几乎所有的网络流量都是通过TCP来进行的
要建立连接需要三次握手
第一步： 客户端向服务器发送一个同步消息，被称为SYN

第二部是客户端响应一个同步消息同时确认客户端的同步，被称为SYN-ACK

第三步是客户端通过确认服务器的同步请求来响应，被称为ACK

从网络层的角度来看，发送到同一台计算机上的不同应用程序的数据包看起来是一样的
意味着要与另一个程序建立TCP连接，我们需要两个地址

第一个是IP地址，是网络层用来将数据包传送到计算机的地址，第二个是TCP端口，告诉计算机软件
将数据传送到哪个应用程序

## Inside the Stream
我们通过一系列的中间计算机即路由器将IP数据包传输到目的地
客户端和服务器之间的ip数据包会经过多次跳跃，其中一次跳跃指的是连接两个路由器之间的链路

一个路由器可以有许多连接他的链路，当每个数据包到达时，路由器决定通过他的哪条链路发送

路由器有自己的IP地址，因此他也可以不转发数据包，而是将其交付给自己的软件

路由器通过一个叫转发表的东西来做决定，转发表由一组ip地址模式以及其对应的链路组成，每个模式对应一组链路
当一个数据包到达时，路由器会检查哪个转发表条目的模式与该数据包最匹配

# Principle: Packet Switching
数据包是一个自包含的数据单元，携带者使其能够到达目的地的必要信息

分组交换的理念是将我们的数据分割成离散的自包含的数据块，每个称为数据包的块携带者足够的信息使得网络能够将数据包一直传送到目的地

对于每个到达的数据包，我们独立地选择其输出链路，如果链路空闲，我们就发送他，否则就暂存稍后再发送

交换机可以拥有一个包含目标地址和下一跳的表，当他接收到一个数据包时，会在表中查找地址并将数据包发送到响应的下一跳，在这种模式下，数据包只需携带目标地址

分组交换有两个好处：
1. 交换机可以为每个数据包做出单独的本地决策，他不需要为已经见过的数据包或者两个数据包是否发往同一目的地保留额外状态

2. 他让我们能够高效的在多个用户之间共享链路

我们将一系列数据包称为一个流，流是同一段到端通信中数据报的集合

分组交换可以让交换机变得简单，因为他不需要了解数据包的流
他让我们能够高效的在共享同一连接的多个流之间共享容量

# Principle：Layering
Layering: 是指将系统组织成多个独立的功能组件或层次的过程

这些层次是分级的，并且他们按照顺序进行通讯，每一层只和他的上层和下层有接口

# Encapslation Principle
封装是将分组交换和分层结合起来的产物

封装是一种准测，通过他你可以组织数据包中的信息，以便技能维持各层结构又能共享数据包中的内容

实际上会用递归来封装各个层的协议，这提供了相当大的灵活性

封装是我们如何将协议层组合成数据包以实现灵活性并保持各层关注点的分离

# Memory, Byte Order and Packet Formats
分为小端序和大端序，分别代表在十六位进制下

小端序指的是最低有效字节位于最低地址，因此在内存中最低有效字节排在最前面

大段序则是反过来
## Network Byte Order
如果两个计算机想要通信，他们就必须要同一使用大端序或者小端序数

所有互联网规范协议都使用大端序作为格式

为了解决这个兼容问题，c语言库提供了一个转换函数

函数h2ns接收一个主机短整型作为参数，并返回一个网络序的值，也有反过来将网络短整型转换为主机短整型的函数，
以及用于长整型的函数

# Names and Address: IPv4是32字节
IPv4的地址长度为32位，通常被写进4个八位组，形式为a.b.c.d，每个八位组有8个二进制位

除了地址之外，设备通常还有一个被称为子网掩码的东西，告诉你哪些ip地址是本地的，位于同一链路或同一网络，哪些需要通过ip路由器

子网掩码从最高有效位开始的一串连续的1来表示，你可以通过将两个地址与子网掩码进行按位与来判断是否处在同一网络中，如果地址相同则他们在同一网络中

## Address Structure
IPv4地址现在利用一种称为CIDR的技术来优化
当我们谈论CIDR地址时，我们指的是其网络掩码长度

# Longest Prefix Match
为了决定通过哪条链路转发数据包，现代路由器通常使用一种称为最长公共前缀的算法

每一跳的决策由一个叫转发表的东西决定，转发表由一部分ip地址组成

例如171.33.x.x表示第一个字节为171第二个字节为33的任何地址

当一个数据报到达时，路由器会检查哪个转发表条目最匹配该数据包，然后将数据包通过与该条目关联的链路转发出去

LPM是路由器用来决定如何转发数据包的算法

转发表中的条目包含两部分：一部分是描述地址块的CIDR，另一部分是匹配该CIDR条目的数据包的下一跳，一个地址可能属于多个CIDR条目

路由器会匹配最具体的那一个链路来转发

对于这个最匹配的定义：比如转发表中一个ip是171.0.15.0/24 
那么他要对于目标ip需要和前24位置进行一个按位与的操作也就是255.255.255.0
然后再来和转发表中的ip进行匹配，如果有多个符合目标就找掩码最长的也就是最精确的那个

# Address Resolution Protocol(ARP) 
地址解析协议（ARP）是一种机制，网络层通过它能够发现与其直接相连的网络地址所对应的链路地址

他解决了这样一个问题：设备如何知道我有一个IP数据包其下一跳地址是这个，我应该将它发送到哪一个地址

ARP是必要的因为每个协议层都有自己的名称和地址

IP地址是网络层中的地址，它描述了一个主机即网络层的唯一目的地，相比之下，链路地址描述了一个特定的网卡，即发送和接收链路层帧的唯一设备
