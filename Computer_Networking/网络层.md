本章的重要概念是
1. 虚拟互联网络和两种服务，两个层面的概念
2. ip地址和mac地址的关系
3. 传统分类的ip地址和无分类域间选择CIDR
4. 路由选择协议的工作原理

# 网络层的几个重要概念
## 网络层提供的两种服务
当两台计算机进行通信时，应当先建立连接，分组交换中是建立一条虚电路VC

互联网采用的设计思路是这样的：网络层要设计的尽量简单，向其上层只提供简单灵活的、无连接的、尽最大努力交付的数据报服务

### 网络层的两个层面
路由器之间传送的信息有以下两大类：
1. 转发源主机和目的主机之间所传送的数据
2. 传送路由信息，目的是为了在路由器中创建路由表，导出为转发分组而用的转发表

也就把网络层抽象的划分为数据层面和控制层面

# 国际协议ip
与协议ip配套使用的还有三个协议
1. 地址解析协议ARP
2. ICMP
3. IGMP

将网络互相连接起来要使用一些中间设备
1. 物理层使用的是转发器
2. 数据链路层使用的是网桥或桥接器以及交换机
3. 网络层使用的是路由器
4. 网络层以上的是网关

所谓虚拟互联网络也就是逻辑互联网络，他的意思就是互联起来的各种物理网络互联起来的各种物理网络的异构性本来是客观存在的，但可以利用ip使得这些性能各异的网络在网络层上看起来是一个统一的网络

互联网可以由多种异构网络互联组成

# ip地址 
ip地址就是给连接到互联网上的每一台主机的每一个接口分配一个在全世界范围内是唯一的32位的标识符

ip地址不但标志了这个主机，还标识了此接口所连接的网络，第一个字段是网络号，表示所连接的网络，第二个是主机号，他标志着该主机
## 无分类编址CIDR
网络前缀的位数n是一个不固定的值，可以在0-32任选

一个大的CIDR地址快中往往包含很多小的地址块，所以在路由器中的转发表中就利用较大的一个CIDR地址块来代替许多小的地址块，这个被称为构造超网

## ip地址的特点
路由器根据目的主机所连接的网络前缀来转发分组，这样就可以使转发表中的项目数大幅度减少，从而减少转发表所占的存储空间，减少查找转发表的时间

ip地址是标志一台主机和一条链路的接口，当一台主机同时连接到两个网络上时，该主机就必须同时拥有两个相应的ip地址，这种主机被称为多归属主机

用转发器或交换机连接起来的若干个局域网仍为一个网络

## ip地址和MAC地址
mac地址是数据链路层使用的地址，ip地址是网络层和以上各层使用的地址，是一种逻辑地址

再局域网的链路层只能看到mac帧

## 地址解析协议ARP
地址解析协议ARP就是用来解决已经知道一个机器的ip地址然后要找出对应的mac地址的这个问题

地址解析协议ARP解决这种问题的方法是在主机ARP高速缓存从ip地址到mac地址的映射表，这个表还经常动态更新

每台主机都设有一个ARP高速缓存，存有本局域网上各主机和路由器的ip地址到mac地址的映射表

当主机a要向本局域网上的某台主机发送ip数据报时，就先在其arp高速缓存中查看有无主机b的ip地址，如有，就在缓存中找到对应的mac地址，再把这个mac地址写入mac帧

如果找不到就会自行运行arp，在局域网上广播一个arp请求分组，如果有与这个要查询的ip地址一致的主机，就会向主机a发送arp相应分组，写入自己的mac地址

arp对保存在高速缓存的每一个映射地址都有自己的生存时间

**arp用于解决同一个局域网上的主机或路由器的ip地址和mac地址的映射**

主机的用户对这种地址解析过程是不知道的

查找转发表的过程就是寻找前缀匹配的过程

## 最长前缀匹配
主机路由又叫做特定主机路由，这是对特定目的主机的ip地址专门指明的一个路由

还有一种特殊路由是默认路由，不管分组的最终目的网络再哪里，都由指定的路由器R来处理

# ICMP
icmp报文有两种，分别是icmp差错报文和icmp询问报文

icmp差错报告报文有四种：
1. 终点不可达
2. 时间超过
3. 参数问题
4. 改变路由

icmp询问报文有两种：
1. 回送请求或回送回答
2. 时间戳请求或时间戳回答

# ipv6
ipv6数据报由两大部分组成，即基本首部和有效载荷，然后是数据部分

基本首部各字段的作用：
1. 版本
2. 通信量类
3. 流标号

## ipv6的地址
有以下三种基本类型地址
1. 单播
2. 多播    一点对多点的通信
3. 任播    任意一组计算机

# ipv4到ipv6
双协议栈，隧道技术

icmpv6

# 互联网的路由选择协议
需要何种算法来获得路由表中的各项目

互联网采用的路由选择协议主要是自适应的，分布式路由选择协议

可以把整个互联网划分为许多较小的自治系统，一般都记作AS，每一个AS对其他的AS表现出的是一个单一的和一致的路由选择协议，这样互联网就把路由选择协议分成了两大类：
1. 内部网关协议    在一个AS内部使用的路由选择协议
2. 外部网关协议    再不同AS之间的路由选择

## 内部网关协议RIP
RIP是一种分布式的基于距离向量的路由选择协议

要求网络中的每一个路由器都要维护从他自己到其他每一个目的网络的距离记录，也就是跳数

RIP仅和相邻的路由器交换信息

路由器交换的信息是当前本路由器所知道的所有信息，即现在自己的路由表

按固定的时间间隔交换路由信息

### 距离向量算法
对每一个相邻路由器发送过来的RIP报文执行以下步骤：

对地址为x的相邻路由器发来的RIP报文，先修改报文中的所有项目，把下一跳字段中的地址都改成x，把所有距离字段+1 

更新的算法是最短路算法，如果需要更新的路由表中没有这个目的地址则直接添加，如果有并且下一跳相同则替换，如果下一跳不同则比较取最小

### 坏消息传播的慢
当网络出现故障时，要经过比较长的时间才能将此信息传送到所有的路由器

好消息传播的快，坏消息传播的慢

## 内部网关协议OSPF
开放最短路径优先OSPF
使用链路状态协议

采用dij最短路算法
特点：
1. 向AS中所有路由器发送消息，这里使用泛洪法
2. 发送的信息就是与不能路由相邻的所有路由器的链路状态，以及该链路的度量

由于各路由器之间频繁交换链路状态信息，所有的路由器最终都能建立一个链路状态数据库，实际上就是全网的拓扑结构图，这个结构图在全网范围内是一致的

OSPF更新过程收敛的更快，他将一个AS分为若干个更小的部分，叫做区域

OSPF使用结构层次的区域划分，上层区域叫做主干区域，标识符规定为0.0.0.0
从其他区域来的信息都是区域边界路由器，在主干区域的路由器叫主干路由器

主干区域内还有一个路由器专门和本AS外的自治系统交换路由信息，这样的路由器叫自治系统边界路由器

OSPF对于不同类型的业务可以计算出不同的路由

如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径，这叫多路径间的负载均衡

都具备鉴别的功能

OSPF不用UDP二十直接用IP数据报传送

## 外部网关协议BGP
BGP力求选择出一条能够到达目的网络前缀且比较好的路由，并非计算出一条最佳路由

采用了路径向量路由选择协议

### BGP路由
协议BGP规定，在一个AS内部所有的iBGP必须是全联通的

eBGP是在不同AS的两个对等端之间的BGP连接，iBGP是同一AS之间的BGP连接

BGP路由=前缀，BGP属性=前缀，AS-PATH，NEXT-PATH

前缀就是通告的BGP路由终点
AS-PATH 自治系统路径，是通告的BGP所经过的自治系统
NEXT-PATH 下一跳，是通告的BGP的路由起点

### 三种不同的自治系统AS
可以划分为三大类：末梢AS，穿越AS，对等AS

末梢AS不会把来自其他AS的分组再转发给另一个AS，它也可以连接两个或两个以上的AS，被称为多归属AS

对等AS是经过事先协商的两个AS，彼此的发送或接受分组都不收费

BGP路由必须避免兜圈子的出现

### BGP的路由选择
本地偏好值高的路由要优先选择
选择具有AS跳数最少的路由
如果前两种都无法选择则使用热土豆路由选择算法，就是让数据尽快离开这个AS
选择BGP标识符最小的路由

### BGP的四种报文
OPEN,UPDATE,KEEPALIVE,NOTIFICATION

协议BGP采用的方法是让BGP连接的两个对等端之间周期性地交换KEEPALIVE报文

每个路由器都有一个保持时间计时器，发送KEEPALIVE报文为商定的保持时间的1/3 

## 路由器的构成
整个的路由器结构可以划分为两大部分：路由选择部分和分组转发部分

选择部分也是控制部分，任务是根据所选定的路由选择协议构造出路由表

分组转发部分也是数据层面，由三部分组成：交换结构，一组输入端口，一组输出端口

交换结构的作用就是根据转发表对分组进行处理

# IP多播
能运行多播协议的路由器被称为多播路由器

多播地址只能用于目的地址不能用于源地址，并且不产生ICMP差错报文

## 国际组管理协议IGMP和多播路由选择协议
IGMP协议是让链接在本地局域网上的多播路由器知道本局域网上是否有主机参加或退出了某个多播组

还需要多播路由选择协议

多播转发必须动态的刷应多播组成员的变化，此时网络拓扑并未发生变化

多播路由器再转发多播数据报时，不仅仅根据多播数据报中的目的地址，而是还要考虑多播数据报从什么地方来和到什么地方去

多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络

### 多播路由选择协议
多播路由器实际上就是要找出以源主机为根节点的多播转发树，在转发多播数据报时用了以下三种方法:
1. 洪泛与剪除
为了避免兜圈子使用了反向路径广播RPB

如果在多播转发树上的某个路由器发现它的下游树枝没有该多播组的成员，就应该把他和下游的树枝一起剪除

2. 隧道技术
如果途中有路由器不支持多播，则封装成单播数据报然后通过隧道直接发送到支持多播的路由器

3. 基于核心的发现技术
对每一个多播组G指定一个核心路由器，给出他的ip单播地址，通过核心路由器控制整个多播组

# 虚拟专用网VPN和网络地址转换NAT
专用地址只能用作本地地址而不能用作全球地址，在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发

采用这样的专用ip地址的互联网被称为专用互联网，专用ip地址也被称为可重用地址

可以利用公用的互联网作为本机构个专用网之间的通信载体，这样的专用网被称为虚拟专用网VPN，所有通过互联网传输的数据都必须加密

分为内联网，外联网和远程接入VPN

## 网络地址转换NAT


